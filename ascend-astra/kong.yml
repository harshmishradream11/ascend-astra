_format_version: "1.1"
services:
  - connect_timeout: 10000
    host: localhost
    name: testlab
    port: 8100
    protocol: http
    read_timeout: 10000
    retries: 1
    write_timeout: 10000
    tags:
      - testlab
    routes:
      - name: allocations
        methods:
          - GET
        paths:
          - /v1/allocations
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - testlab
        https_redirect_status_code: 426
      - name: re-allocate
        methods:
          - PUT
        paths:
          - /v1/allocations
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - testlab
        https_redirect_status_code: 426

  # Flockr Admin API Service (port 8250)
  - connect_timeout: 10000
    host: localhost
    name: flockr-admin
    port: 8250
    protocol: http
    read_timeout: 60000
    retries: 1
    write_timeout: 60000
    tags:
      - flockr-admin
    routes:
      # Audiences
      - name: flockr-admin-list-audiences
        methods:
          - GET
        paths:
          - /v1/audiences
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-admin
          - audiences
        https_redirect_status_code: 426
      - name: flockr-admin-create-audience
        methods:
          - POST
        paths:
          - /v1/audiences
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-admin
          - audiences
        https_redirect_status_code: 426
      - name: flockr-admin-get-audience-details
        methods:
          - GET
        paths:
          - ~/v1/audiences/(?<audienceId>\d+)$
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 100
        strip_path: false
        tags:
          - flockr-admin
          - audiences
        https_redirect_status_code: 426
      - name: flockr-admin-create-rules
        methods:
          - POST
        paths:
          - ~/v1/audiences/(?<audienceId>\d+)/rules$
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 100
        strip_path: false
        tags:
          - flockr-admin
          - audiences
        https_redirect_status_code: 426
      - name: flockr-admin-get-rule-details
        methods:
          - GET
        paths:
          - ~/v1/audiences/(?<audienceId>\d+)/rules/(?<ruleId>\d+)$
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 200
        strip_path: false
        tags:
          - flockr-admin
          - audiences
        https_redirect_status_code: 426
      - name: flockr-admin-get-audience-owners
        methods:
          - GET
        paths:
          - ~/v1/audiences/(?<audienceId>\d+)/owners$
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 100
        strip_path: false
        tags:
          - flockr-admin
          - audiences
        https_redirect_status_code: 426
      - name: flockr-admin-update-audience-owner
        methods:
          - POST
        paths:
          - ~/v1/audiences/(?<audienceId>\d+)/owners$
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 100
        strip_path: false
        tags:
          - flockr-admin
          - audiences
        https_redirect_status_code: 426
      # Audience Imports
      - name: flockr-admin-create-import
        methods:
          - POST
        paths:
          - ~/v1/audiences/(?<audienceId>\d+)/imports$
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 100
        strip_path: false
        tags:
          - flockr-admin
          - audience-imports
        https_redirect_status_code: 426
      # Data Connectors - Connector Types
      - name: flockr-admin-list-connector-types
        methods:
          - GET
        paths:
          - /v1/connectors/types
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-admin
          - data-connectors
        https_redirect_status_code: 426
      - name: flockr-admin-get-connector-type
        methods:
          - GET
        paths:
          - ~/v1/connectors/types/(?<typeId>\d+)$
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 100
        strip_path: false
        tags:
          - flockr-admin
          - data-connectors
        https_redirect_status_code: 426
      - name: flockr-admin-onboard-connector-type
        methods:
          - POST
        paths:
          - /v1/connectors/types/onboard
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-admin
          - data-connectors
        https_redirect_status_code: 426
      # Data Connectors - Data Sinks
      - name: flockr-admin-list-data-sinks
        methods:
          - GET
        paths:
          - /v1/datasinks
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-admin
          - data-connectors
        https_redirect_status_code: 426
      - name: flockr-admin-onboard-data-sink
        methods:
          - POST
        paths:
          - /v1/datasinks/onboard
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-admin
          - data-connectors
        https_redirect_status_code: 426
      # Data Connectors - Data Sources
      - name: flockr-admin-list-data-sources
        methods:
          - GET
        paths:
          - /v1/datasources
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-admin
          - data-connectors
        https_redirect_status_code: 426
      - name: flockr-admin-onboard-data-source
        methods:
          - POST
        paths:
          - /v1/datasources/onboard
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-admin
          - data-connectors
        https_redirect_status_code: 426

  # Flockr Users API Service (port 8260)
  - connect_timeout: 10000
    host: localhost
    name: flockr-users
    port: 8260
    protocol: http
    read_timeout: 60000
    retries: 1
    write_timeout: 60000
    tags:
      - flockr-users
    routes:
      # Bulk Cohort Assignment
      - name: flockr-users-bulk-assign
        methods:
          - POST
        paths:
          - /flockr/users/assignments/bulk
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-users
          - bulk-cohort-assignment
        https_redirect_status_code: 426
      # User Cohorts
      - name: flockr-users-get-cohorts
        methods:
          - GET
        paths:
          - /flockr/users/get-cohorts
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-users
          - user-cohorts
        https_redirect_status_code: 426
      # Health Check
      - name: flockr-users-healthcheck
        methods:
          - GET
        paths:
          - /healthcheck
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 0
        strip_path: false
        tags:
          - flockr-users
          - health-check
        https_redirect_status_code: 426
      # User Cohort Mapping
      - name: flockr-users-map-cohorts
        methods:
          - POST
        paths:
          - /flockr/users/map-cohorts
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 100
        strip_path: false
        tags:
          - flockr-users
          - user-cohort-mapping
        https_redirect_status_code: 426
      - name: flockr-users-map-cohorts-batch
        methods:
          - POST
        paths:
          - /flockr/users/map-cohorts/batch
        path_handling: v1
        preserve_host: false
        protocols:
          - http
          - https
        regex_priority: 200
        strip_path: false
        tags:
          - flockr-users
          - user-cohort-mapping
        https_redirect_status_code: 426

plugins:
  # Global CORS - allows frontend to access Kong APIs
  - name: cors
    config:
      origins:
        - http://localhost:5173
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        - HEAD
      headers:
        - Accept
        - Accept-Language
        - Content-Language
        - Content-Type
        - Authorization
        - X-Requested-With
        - X-Request-ID
        - X-Api-Key
      exposed_headers:
        - X-Request-ID
      credentials: true
      max_age: 3600
    enabled: true
    protocols:
      - http
      - https

  - name: swap-header
    service: testlab
    config:
      source_header: x-api-key
      target_header: x-project-key
    enabled: true
    protocols:
      - http
      - https
    tags:
      - testlab


  - name: swap-header
    service: flockr-admin
    config:
      source_header: x-api-key
      target_header: x-project-key
    enabled: true
    protocols:
      - http
      - https
    tags:
      - flockr-admin

  - name: swap-header
    service: flockr-users
    config:
      source_header: x-api-key
      target_header: x-project-key
    enabled: true
    protocols:
      - http
      - https
    tags:
      - flockr-users

  - name: circuit-breaker
    config:
      api_call_timeout_ms: 1000
      error_msg_override: null
      error_status_code: 599
      excluded_apis: '{}'
      failure_percent_threshold: 51
      half_open_max_calls_in_window: 8
      half_open_min_calls_in_window: 3
      min_calls_in_window: 10
      response_header_override: null
      set_logger_metrics_in_ctx: true
      wait_duration_in_half_open_state: 120
      wait_duration_in_open_state: 15
      window_time: 10
    enabled: true
    protocols:
      - grpc
      - grpcs
      - http
      - https